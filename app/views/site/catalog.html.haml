#google-modal.hide

#calendar-modal.modal.hide.fade
  .modal-header
    %a.close{:'data-dismiss' => 'modal'} ×
    %h3 Choose your calendar
  .modal-body
  .modal-footer
    = link_to 'Close', 'javascript:void(0)', :'data-dismiss' => 'modal', class: 'btn'
    = link_to 'Select', 'javascript:void(0)', :'data-dismiss' => 'modal', class: 'btn btn-success'

#unenroll-modal.modal.hide.fade
  .modal-header
    %a.close{:'data-dismiss' => 'modal'} ×
    %h3 Unenroll
  .modal-body{style: 'text-align:center'}
    = form_tag '', remote: true do
      = hidden_field_tag :user_id
      = text_area_tag :message, '', placeholder: 'Why are you unenrolling? (And if requesting a refund, please explain why.)', style: 'width:400px;height:100px'
  .modal-footer
    = link_to 'Close', 'javascript:void(0)', :'data-dismiss' => 'modal', class: 'btn'
    = link_to 'Unenroll', 'javascript:void(0)', :'data-dismiss' => 'modal', class: 'btn btn-danger', id: 'unenroll'

#destroy-modal.modal.hide.fade
  .modal-header
    %a.close{:'data-dismiss' => 'modal'} ×
    %h3 Sign in
  .modal-body
    Really destroy
    %span>
    ?
  .modal-footer
    = link_to 'Close', 'javascript:void(0)', :'data-dismiss' => 'modal', class: 'btn'
    = link_to 'Destroy', 'javascript:void(0)', :'data-dismiss' => 'modal', class: 'btn btn-danger', id: 'destroy', remote: true

#catalog_header
  %h1 Courses
  #catalog_header_content
    - if current_user && organization.admins.include?(current_user)
      = link_to 'Add new', '/admin/courses', class: 'btn btn-primary'
    = form_tag "/site/search", class: 'form-search', remote: true do
      = text_field_tag :q, '', placeholder: 'search', class: 'search-query'
      = hidden_field_tag :mirai
      = hidden_field_tag :uid
      = submit_tag :Search, class: 'btn btn-info'
    #previous_container
      Show Past Courses
      = check_box_tag :previous
.tabbable
  %ul.nav.nav-tabs
    %li.active= link_to 'all', '#all', :'data-toggle' => 'tab'
    - if current_user
      %li= link_to 'my enrollments', '#enrollments', :'data-toggle' => 'tab'

  .tab-content#courses
    #all.tab-pane.active= render partial: 'site/course_table'
    - if current_user
      #enrollments.tab-pane
        - if current_user.courses.mirai.first
          %h3= current_user.name
          = render partial: 'site/course_table', locals: { user: current_user }
        - current_user.campers.each do |camper|
          - if camper.courses.mirai.first
            %h3= camper.name
            = render partial: 'site/course_table', locals: { user: camper }

:javascript
  function closeGcal() {
    $('#google-modal').bPopup().close()
    $('#calendar-modal .modal-body').html('')
    for (var i=0; i < data.calendars.length; i++) {
      $('#calendar-modal .modal-body').append('<input type="radio" name="calendar" value="' + data.calendars[i].id + '"> ' + data.calendars[i].title + '<br/>')
    }
    $('#calendar-modal .modal-body').append('<select id="timezone"></select>')
    $('#calendar-modal select').append('<option value="-12:00">-12:00</option>').append('<option value="-11:00">-11:00</option>').append('<option value="-10:00">-10:00</option>').append('<option value="-09:00">-09:00</option>').append('<option value="-08:00">-08:00</option>').append('<option value="-07:00">-07:00</option>').append('<option value="-06:00">-06:00</option>').append('<option value="-05:00">-05:00</option>').append('<option value="-04:00">-04:00</option>').append('<option value="-03:00">-03:00</option>').append('<option value="-02:00">-02:00</option>').append('<option value="-01:00">-01:00</option>').append('<option value="-00:00">-00:00</option>').append('<option value="+01:00">+01:00</option>').append('<option value="+02:00">+02:00</option>').append('<option value="+03:00">+03:00</option>').append('<option value="+04:00">+04:00</option>').append('<option value="+05:00">+05:00</option>').append('<option value="+06:00">+06:00</option>').append('<option value="+07:00">+07:00</option>').append('<option value="+08:00">+08:00</option>').append('<option value="+09:00">+09:00</option>').append('<option value="+10:00">+10:00</option>').append('<option value="+11:00">+11:00</option>').append('<option value="+12:00">+12:00</option>').append('<option value="+13:00">+13:00</option>').append('<option value="+14:00">+14:00</option>')
    $('#timezone').val("#{current_user.timezone}")
    $('#calendar-modal').modal()
    $('#calendar-modal').modal('show')
  }
  $('.export').click(function(){
    $.post(
      '/site/calendar_list',
      { courses: [$(this).attr('cid')] },
      function(rsp) {
        if (rsp.success) {
          $('#calendar-modal .modal-body').html('')
          for (var i=0; i < rsp.calendars.length; i++) {
            $('#calendar-modal .modal-body').append('<input type="radio" name="calendar" value="' + rsp.calendars[i].id + '"> ' + rsp.calendars[i].title + '<br/>')
          }
          $('#calendar-modal .modal-body').append('<select id="timezone"></select>')
          $('#calendar-modal select').append('<option value="-12:00">-12:00</option>').append('<option value="-11:00">-11:00</option>').append('<option value="-10:00">-10:00</option>').append('<option value="-09:00">-09:00</option>').append('<option value="-08:00">-08:00</option>').append('<option value="-07:00">-07:00</option>').append('<option value="-06:00">-06:00</option>').append('<option value="-05:00">-05:00</option>').append('<option value="-04:00">-04:00</option>').append('<option value="-03:00">-03:00</option>').append('<option value="-02:00">-02:00</option>').append('<option value="-01:00">-01:00</option>').append('<option value="-00:00">-00:00</option>').append('<option value="+01:00">+01:00</option>').append('<option value="+02:00">+02:00</option>').append('<option value="+03:00">+03:00</option>').append('<option value="+04:00">+04:00</option>').append('<option value="+05:00">+05:00</option>').append('<option value="+06:00">+06:00</option>').append('<option value="+07:00">+07:00</option>').append('<option value="+08:00">+08:00</option>').append('<option value="+09:00">+09:00</option>').append('<option value="+10:00">+10:00</option>').append('<option value="+11:00">+11:00</option>').append('<option value="+12:00">+12:00</option>').append('<option value="+13:00">+13:00</option>').append('<option value="+14:00">+14:00</option>')
          $('#timezone').val("#{current_user.timezone}")
          $('#calendar-modal').modal()
          $('#calendar-modal').modal('show')
        } else {
          $('#google-modal').html('<iframe id="gcal-iframe" src="http://localhost:3000/auth/google_oauth2" width="800" height="600"></iframe>')
          $('#google-modal').bPopup()
        }
      }, 'json'
    )
  })
  $('#calendar-modal .btn-success').click(function(){
    $.post(
      '/site/gcal_import',
      { timezone: $('#timezone').val() },
      function(rsp) {
      }, 'json'
    )
  })
  $('#unenroll').click(function(){
    $('#unenroll-modal form').submit()
    $('.course' + $(this).attr('cid') + ':last').fadeOut('slow')
  })
  $('.unenroll').live('click', function(){
    $('#unenroll-modal form').attr('action', '/courses/' + $(this).attr('cid') + '/unenroll')
    $('#unenroll-modal #user_id').val($(this).attr('uid'))
    $('#unenroll').attr('cid', $(this).attr('cid'))
  })
  $('.actions a').tipTip({ delay: 200 })
  $('.form-search').submit(function(){
    if ( $('#enrollments').hasClass('active') ) {
      $('#uid').val('#{current_user && current_user.id}')
    } else {
      $('#uid').val('')
    }
    if ( $('#previous:checked').length > 0 ) {
      $('#mirai').val('false')
    } else {
      $('#mirai').val('true')
    }
  })
  $('.destroy').live('click', function(){
    $('#destroy-modal span').text(' ' + $(this).attr('course'))
    $('#destroy-modal .btn-danger').attr('href', '/admin/courses/' + $(this).attr('cid') + '/destroy')
  })
  $('#previous').change(function(){
    $('.form-search').submit()
  })
  $('tbody tr > :not(.actions)').live('click', function(){
    window.location = '/courses/' + $(this).parent().attr('cid') + '/' + $(this).parent().attr('lowname')
  })
  $.tablesorter.addParser({
    id: 'dates',
    is: function(s){return false},
    type: 'numeric',
    format: function(s,t,c) {
      return $(c).attr('date')
    }
  })
  $.tablesorter.addParser({
    id: 'times',
    is: function(s){return false},
    type: 'numeric',
    format: function(s,t,c) {
      return $(c).attr('time')
    }
  })
  $('table').tablesorter({
    headers: {
      4: { sorter: 'dates' },
      5: { sorter: 'times' },
      6: { sorter: 'times' },
      7: { sorter: false }
    }
  })
